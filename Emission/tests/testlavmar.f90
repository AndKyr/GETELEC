program testlavmar

use Levenberg_Marquardt, only: nlinfit
use std_mat	, only : linspace,plot
use emission, only : fitpot, J_from_Vx


integer,parameter ::dp=8
real(dp)		:: xdata(100),ydata(100),error(100),xdatcomp(100,2),ydatcomp(100,2)
real(dp)		:: F,R,gamma
real(dp) 		:: var,t1,t2,J,heat,T=350.d0,W=4.5d0
integer i

xdata=dble([1.00000e-05,1.00010e-01,2.00010e-01,3.00010e-01,4.00010e-01,5.00010e-01,6.00010e-01,7.00010e-01,8.00010e-01,9.00010e-01,1.00001e+00,1.10001e+00,1.20001e+00,1.30001e+00,1.40001e+00,1.50001e+00,1.60001e+00,1.70001e+00,1.80001e+00,1.90001e+00,2.00001e+00,2.10001e+00,2.20001e+00,2.30001e+00,2.40001e+00,2.50001e+00,2.60001e+00,2.70001e+00,2.80001e+00,2.90001e+00,3.00001e+00,3.10001e+00,3.20001e+00,3.30001e+00,3.40001e+00,3.50001e+00,3.60001e+00,3.70001e+00,3.80001e+00,3.90001e+00,4.00001e+00,4.10001e+00,4.20001e+00,4.30001e+00,4.40001e+00,4.50001e+00,4.60001e+00,4.70001e+00,4.80001e+00,4.90001e+00,5.00001e+00,5.10001e+00,5.20001e+00,5.30001e+00,5.40001e+00,5.50001e+00,5.60001e+00,5.70001e+00,5.80001e+00,5.90001e+00,6.00001e+00,6.10001e+00,6.20001e+00,6.30001e+00,6.40001e+00,6.50001e+00,6.60001e+00,6.70001e+00,6.80001e+00,6.90001e+00,7.00001e+00,7.10001e+00,7.20001e+00,7.30001e+00,7.40001e+00,7.50001e+00,7.60001e+00,7.70001e+00,7.80001e+00,7.90001e+00,8.00001e+00,8.10001e+00,8.20001e+00,8.30001e+00,8.40001e+00,8.50001e+00,8.60001e+00,8.70001e+00,8.80001e+00,8.90001e+00,9.00001e+00,9.10001e+00,9.20001e+00,9.30001e+00,9.40001e+00,9.50001e+00,9.60001e+00,9.70001e+00,9.80001e+00,9.90001e+00])
ydata=.7d0*dble([1.57237e-04,8.58148e-01,1.69936e+00,2.52431e+00,3.33349e+00,4.12739e+00,4.90647e+00,5.67117e+00,6.42191e+00,7.15910e+00,7.88313e+00,8.59439e+00,9.29322e+00,9.98000e+00,1.06550e+01,1.13187e+01,1.19712e+01,1.26130e+01,1.32442e+01,1.38653e+01,1.44763e+01,1.50777e+01,1.56697e+01,1.62524e+01,1.68262e+01,1.73913e+01,1.79478e+01,1.84961e+01,1.90362e+01,1.95685e+01,2.00930e+01,2.06100e+01,2.11197e+01,2.16222e+01,2.21177e+01,2.26064e+01,2.30884e+01,2.35639e+01,2.40330e+01,2.44958e+01,2.49526e+01,2.54034e+01,2.58484e+01,2.62877e+01,2.67215e+01,2.71498e+01,2.75727e+01,2.79904e+01,2.84030e+01,2.88107e+01,2.92134e+01,2.96113e+01,3.00045e+01,3.03931e+01,3.07772e+01,3.11569e+01,3.15323e+01,3.19034e+01,3.22703e+01,3.26332e+01,3.29921e+01,3.33471e+01,3.36982e+01,3.40455e+01,3.43891e+01,3.47291e+01,3.50656e+01,3.53985e+01,3.57280e+01,3.60541e+01,3.63770e+01,3.66965e+01,3.70129e+01,3.73262e+01,3.76363e+01,3.79435e+01,3.82477e+01,3.85489e+01,3.88473e+01,3.91429e+01,3.94357e+01,3.97258e+01,4.00132e+01,4.02980e+01,4.05802e+01,4.08598e+01,4.11369e+01,4.14116e+01,4.16839e+01,4.19538e+01,4.22213e+01,4.24865e+01,4.27495e+01,4.30102e+01,4.32687e+01,4.35251e+01,4.37793e+01,4.40315e+01,4.42816e+01,4.45296e+01])


call cpu_time(t1)
call fitpot(xdata,ydata,F,R,gamma)
call cpu_time(t2)


print *, 'F=', F, '  |  ', 'R=', R, '  |  ', 'gamma=', gamma
print *, 'CPUtime: ', t2-t1
!print *, 'error: ', var


xdatcomp(:,1)=xdata
xdatcomp(:,2)=xdata
ydatcomp(:,1)=ydata
ydatcomp(:,2)=[(fun(xdata(i),[F,R,gamma]),i=1,100)]
call plot(xdatcomp,ydatcomp)
J=J_from_Vx(xdata,ydata,W,T,heat)
print *, 'heat=', heat, '     |  J=', J 

contains

pure function fun(x,p) result(y)
		real(dp), intent(in) :: x
		real(dp), intent(in) :: p(:)
		real(dp)			 :: y
		y=(p(1)*p(2)*x*(p(3)-1.d0)+p(1)*x**2) / (p(3)*x+p(2)*(p(3)-1.d0))
end function fun


end program


